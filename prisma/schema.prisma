datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

enum MayaSessionState {
  new
  qualifying
  qualified
  booked
  submitted
  funded
  declined
  archived
}

model LeadAnalysis {
  id                    String   @id @default(uuid())
  requestedAmount       Float
  industry              String
  creditScore           Int?
  underwritingReadiness String?
  fundingProbability    Float
  expectedCommission    Float
  riskLevel             String
  recommendedAction     String
  createdAt             DateTime @default(now())
}

model CallOutcome {
  id           String   @id @default(uuid())
  leadId       String
  outcome      String
  booked       Boolean
  funded       Boolean?
  fundedAmount Float?
  createdAt    DateTime @default(now())
}

model PerformanceMetric {
  id            String   @id @default(uuid())
  category      String
  key           String
  successRate   Float
  avgCommission Float
  updatedAt     DateTime @updatedAt

  @@unique([category, key], name: "category_key")
}

model CallQueue {
  id        String   @id @default(uuid())
  leadId    String
  priority  Int
  status    String   @default("pending")
  createdAt DateTime @default(now())
}


model ConversationLog {
  id                String   @id @default(uuid())
  leadId            String?
  transcript        String
  extractedRevenue  Float?
  extractedAmount   Float?
  extractedIndustry String?
  urgencyLevel      String?
  bookingIntent     Boolean
  escalated         Boolean
  createdAt         DateTime @default(now())
}


model Lender {
  id                String   @id @default(uuid())
  name              String
  preferredIndustry String
  minAmount         Float
  maxAmount         Float
  createdAt         DateTime @default(now())
}

model RepPerformance {
  id           String   @id @default(uuid())
  repName      String
  assigned     Int
  funded       Int
  totalRevenue Float
  updatedAt    DateTime @updatedAt
}

model Session {
  id                String   @id @default(uuid())
  sessionId         String   @map("session_id")
  task              String
  data              Json
  memo              String?
  qualificationData Json     @default("{}") @map("qualification_data")
  state             MayaSessionState @default(new)
  tier              String?
  fundingScore      Decimal? @map("funding_score") @db.Decimal(5, 2)
  stage             String   @default("new")
  context           Json     @default("{}")
  createdAt         DateTime @default(now()) @map("created_at")
  updatedAt         DateTime? @map("updated_at")

  @@index([state], map: "idx_sessions_state")
  @@index([createdAt], map: "idx_sessions_created_at")
  @@map("sessions")
}

model LenderMatrix {
  id         String   @id @default(dbgenerated("md5((random())::text || (clock_timestamp())::text)"))
  lenderName String   @map("lender_name")
  tier       String
  minAmount  Float    @map("min_amount")
  maxAmount  Float    @map("max_amount")
  createdAt  DateTime @default(now()) @map("created_at")

  @@map("lender_matrix")
}


model LenderRule {
  id                Int      @id @default(autoincrement())
  name              String
  minTimeMonths     Int?     @map("min_time_months")
  minRevenue        Int?     @map("min_revenue")
  minFunding        Int?     @map("min_funding")
  maxFunding        Int?     @map("max_funding")
  allowedIndustries String[] @map("allowed_industries")
  maxRisk           String?  @map("max_risk")

  @@map("lenders")
}

model CallBooking {
  id            String   @id @default(dbgenerated("md5((random())::text || (clock_timestamp())::text)"))
  sessionId     String   @map("session_id")
  phone         String
  requestedTime String   @map("requested_time")
  status        String   @default("pending")
  createdAt     DateTime @default(now()) @map("created_at")

  @@map("call_bookings")
}


model LenderUser {
  id           Int    @id @default(autoincrement())
  lenderId     Int?   @map("lender_id")
  email        String @unique
  passwordHash String @map("password_hash")

  @@map("lender_users")
}

model LenderDeal {
  id       Int     @id @default(autoincrement())
  lenderId Int?    @map("lender_id")
  sessionId String? @map("session_id")
  status   String? @default("NEW")

  @@unique([lenderId, sessionId], name: "lender_deals_lender_session_unique")
  @@map("lender_deals")
}

model DealEvent {
  id        Int       @id @default(autoincrement())
  sessionId String?   @map("session_id")
  eventType String?   @map("event_type")
  createdAt DateTime? @default(now()) @map("created_at")

  @@map("deal_events")
}


model MayaSetting {
  id                  Int       @id @default(autoincrement())
  autonomyLevel       Int       @default(1) @map("autonomy_level")
  allowBooking        Boolean   @default(true) @map("allow_booking")
  allowTransfer       Boolean   @default(true) @map("allow_transfer")
  requireConfirmation Boolean   @default(true) @map("require_confirmation")
  allowAdAdjustment   Boolean   @default(false) @map("allow_ad_adjustment")
  maxAutoBudgetAdjustPercent Int @default(10) @map("max_auto_budget_adjust_percent")
  highValueThreshold         Int @default(500000) @map("high_value_threshold")
  autoOutboundEnabled        Boolean @default(false) @map("auto_outbound_enabled")
  allowFullAutoMarketing     Boolean @default(false) @map("allow_full_auto_marketing")
  maxDailyBudgetShiftPercent Int @default(20) @map("max_daily_budget_shift_percent")
  minDataPointsBeforeAdjustment Int @default(30) @map("min_data_points_before_adjustment")
  updatedAt           DateTime? @default(now()) @map("updated_at")

  @@map("maya_settings")
}

model MarketingSession {
  id          Int      @id @default(autoincrement())
  sessionId   String?  @unique @map("session_id")
  utmSource   String?  @map("utm_source")
  utmCampaign String?  @map("utm_campaign")
  booked      Boolean  @default(false)
  funded      Boolean  @default(false)
  createdAt   DateTime @default(now()) @map("created_at")

  @@map("marketing_sessions")
}


model MayaIntelligence {
  id        Int       @id @default(autoincrement())
  metric    String?   @unique
  value     Float?
  updatedAt DateTime? @default(now()) @map("updated_at")

  @@map("maya_intelligence")
}

model MayaDecision {
  id           Int       @id @default(autoincrement())
  sessionId    String?   @map("session_id")
  decisionType String?   @map("decision_type")
  confidence   Float?
  outcome      String?
  createdAt    DateTime? @default(now()) @map("created_at")

  @@map("maya_decisions")
}


model MayaMarketingAction {
  id             Int       @id @default(autoincrement())
  source         String?
  previousBudget Float?    @map("previous_budget")
  newBudget      Float?    @map("new_budget")
  reason         String?
  createdAt      DateTime? @default(now()) @map("created_at")

  @@map("maya_marketing_actions")
}

model DealFeature {
  id              Int       @id @default(autoincrement())
  revenue         Float?
  yearsInBusiness Float?    @map("years_in_business")
  requestedAmount Float?    @map("requested_amount")
  industry        String?
  funded          Boolean?
  createdAt       DateTime? @default(now()) @map("created_at")

  @@map("deal_features")
}
